{% extends 'base.html.twig' %}

{% block title %}Register Pet - HLL DocuPet{% endblock %}

{% block body %}
<div class="px-4 sm:px-0">
    <div class="mx-auto max-w-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
                Register Your Pet
            </h1>
            <p class="mt-4 text-lg text-gray-600">
                Please provide your pet's information below. All fields are required unless marked as optional.
            </p>
        </div>

        <!-- Registration Form -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl p-8">
            <form method="POST" action="{{ path('pet_register') }}" id="pet-registration-form">
                <!-- Pet Name -->
                <div class="mb-6">
                    <label for="name" class="block text-sm font-medium leading-6 text-gray-900">
                        Pet's Name <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-2">
                        <input type="text" name="name" id="name" required
                               class="form-input" 
                               placeholder="Enter your pet's name">
                    </div>
                </div>

                <!-- Pet Type -->
                <div class="mb-6">
                    <label for="type_id" class="block text-sm font-medium leading-6 text-gray-900">
                        Pet Type <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-2">
                        <select name="type_id" id="type_id" required class="form-select">
                            <option value="">Select pet type</option>
                            {% for petType in petTypes %}
                                <option value="{{ petType.id }}">{{ petType.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Breed -->
                <div class="mb-6">
                    <label for="breed_id" class="block text-sm font-medium leading-6 text-gray-900">
                        Breed <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-2">
                        <select name="breed_id" id="breed_id" class="form-select" disabled>
                            <option value="">First select a pet type</option>
                        </select>
                    </div>
                    
                    <!-- Dangerous Breed Warning -->
                    <div id="danger-warning" class="mt-2 hidden">
                        <div class="rounded-md bg-yellow-50 p-4 border border-yellow-200">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-800" id="danger-text">
                                        <!-- Danger text will be inserted here -->
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Breed Options -->
                    <div id="custom-breed-options" class="mt-4 hidden">
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="custom_breed_option" value="dont_know" class="form-radio">
                                    <span class="ml-2 text-sm text-gray-700">I don't know</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="custom_breed_option" value="mix" class="form-radio">
                                    <span class="ml-2 text-sm text-gray-700">It's a mix</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Age Section -->
                <div class="mb-6">
                    <fieldset>
                        <legend class="block text-sm font-medium leading-6 text-gray-900 mb-3">
                            Pet's Age <span class="text-red-500">*</span>
                        </legend>
                        
                        <!-- Birth Date Question -->
                        <div class="mb-4">
                            <p class="text-sm text-gray-700 mb-3">Do you know their date of birth?</p>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="knows_birth_date" value="yes" class="form-radio">
                                    <span class="ml-2 text-sm text-gray-700">Yes</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="knows_birth_date" value="no" class="form-radio">
                                    <span class="ml-2 text-sm text-gray-700">No</span>
                                </label>
                            </div>
                        </div>

                        <!-- Date of Birth Input -->
                        <div id="birth-date-input" class="hidden">
                            <label for="date_of_birth" class="block text-sm font-medium leading-6 text-gray-900">
                                Date of Birth
                            </label>
                            <div class="mt-2">
                                <input type="date" name="date_of_birth" id="date_of_birth" class="form-input">
                            </div>
                        </div>

                        <!-- Approximate Age Input -->
                        <div id="approximate-age-input" class="hidden">
                            <label for="approximate_age" class="block text-sm font-medium leading-6 text-gray-900">
                                Approximate Age
                            </label>
                            <div class="mt-2">
                                <select name="approximate_age" id="approximate_age" class="form-select">
                                    <option value="">Select age</option>
                                    {% for age, value in ageChoices %}
                                        <option value="{{ value }}">{{ age }} year{{ age > 1 ? 's' : '' }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- Sex -->
                <div class="mb-8">
                    <fieldset>
                        <legend class="block text-sm font-medium leading-6 text-gray-900 mb-3">
                            Sex <span class="text-red-500">*</span>
                        </legend>
                        <div class="space-y-2">
                            {% for label, value in sexChoices %}
                                <label class="flex items-center">
                                    <input type="radio" name="sex" value="{{ value }}" required class="form-radio">
                                    <span class="ml-2 text-sm text-gray-700">{{ label }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </fieldset>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="btn btn-primary px-8 py-3 text-lg">
                        Save Pet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('type_id');
    const breedSelect = document.getElementById('breed_id');
    const dangerWarning = document.getElementById('danger-warning');
    const dangerText = document.getElementById('danger-text');
    const customBreedOptions = document.getElementById('custom-breed-options');
    const knowsBirthDateRadios = document.querySelectorAll('input[name="knows_birth_date"]');
    const birthDateInput = document.getElementById('birth-date-input');
    const approximateAgeInput = document.getElementById('approximate-age-input');

    // Handle pet type change
    typeSelect.addEventListener('change', function() {
        const petTypeId = this.value;
        
        if (petTypeId) {
            fetch(`/pet/api/breeds/${petTypeId}`)
                .then(response => response.json())
                .then(breeds => {
                    breedSelect.innerHTML = '<option value="">Select breed</option>';
                    
                    breeds.forEach(breed => {
                        const option = document.createElement('option');
                        option.value = breed.id;
                        option.textContent = breed.name;
                        option.dataset.dangerous = breed.isDangerous;
                        breedSelect.appendChild(option);
                    });
                    
                    // Add "Can't find it?" option
                    const cantFindOption = document.createElement('option');
                    cantFindOption.value = 'cant_find';
                    cantFindOption.textContent = "Can't find it?";
                    breedSelect.appendChild(cantFindOption);
                    
                    breedSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching breeds:', error);
                    breedSelect.innerHTML = '<option value="">Error loading breeds</option>';
                });
        } else {
            breedSelect.innerHTML = '<option value="">First select a pet type</option>';
            breedSelect.disabled = true;
            dangerWarning.classList.add('hidden');
            customBreedOptions.classList.add('hidden');
        }
    });

    // Handle breed change
    breedSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (this.value === 'cant_find') {
            customBreedOptions.classList.remove('hidden');
            dangerWarning.classList.add('hidden');
        } else {
            customBreedOptions.classList.add('hidden');
            
            if (selectedOption.dataset.dangerous === 'true') {
                dangerText.textContent = `${selectedOption.textContent} is considered dangerous.`;
                dangerWarning.classList.remove('hidden');
            } else {
                dangerWarning.classList.add('hidden');
            }
        }
    });

    // Handle birth date knowledge change
    knowsBirthDateRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'yes') {
                birthDateInput.classList.remove('hidden');
                approximateAgeInput.classList.add('hidden');
                document.getElementById('approximate_age').value = '';
            } else {
                birthDateInput.classList.add('hidden');
                approximateAgeInput.classList.remove('hidden');
                document.getElementById('date_of_birth').value = '';
            }
        });
    });
});
</script>
{% endblock %}
